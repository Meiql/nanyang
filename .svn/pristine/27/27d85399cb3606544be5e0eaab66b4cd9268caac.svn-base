package org.springrain.erp.gz.web;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springrain.erp.constants.DicdataTypeEnum;
import org.springrain.erp.constants.ErpStateEnum;
import org.springrain.erp.gz.dto.UserSalaryDto;
import org.springrain.erp.gz.entity.Salary;
import org.springrain.erp.gz.entity.Salaryinfo;
import org.springrain.erp.gz.service.ISalaryService;
import org.springrain.erp.gz.service.ISalaryinfoService;
import org.springrain.erp.gz.util.GlobalStaticVar.SalaryStateEnum;
import org.springrain.erp.tc.entity.TongchouRecord;
import org.springrain.erp.tc.entity.TongchouZengjian;
import org.springrain.erp.tc.service.ITongchouRecordService;
import org.springrain.erp.tc.service.ITongchouZengjianService;
import org.springrain.frame.common.SessionUser;
import org.springrain.frame.controller.BaseController;
import org.springrain.frame.util.DateUtils;
import org.springrain.frame.util.GlobalStatic;
import org.springrain.frame.util.Page;
import org.springrain.frame.util.ReturnDatas;
import org.springrain.system.entity.DicData;
import org.springrain.system.entity.Org;
import org.springrain.system.service.IDicDataService;
import org.springrain.system.service.IOrgService;

@Controller
@RequestMapping(value="/user/salary")
public class UserSalaryController extends BaseController {
	@Resource
	private IDicDataService dicDataService;
	@Resource
	private ISalaryService salaryService;
	@Resource
	private ISalaryinfoService salaryinfoService;
	@Resource
	private ITongchouRecordService tongchouRecordService;
	@Resource
	private ITongchouZengjianService tongchouZengjianService;
	@Resource
	private IOrgService orgService;

	@RequestMapping("/configure")
	public String configureUpdatePre(Model model,HttpServletRequest request,HttpServletResponse response)  throws Exception{
		ReturnDatas returnObject = lookConfigureJson(model, request, response);
		model.addAttribute(GlobalStatic.returnDatas, returnObject);
		return "/erp/gz/userSalary/configureCru";
	}
	
	@RequestMapping("/look/configure/json")
	public @ResponseBody ReturnDatas lookConfigureJson(Model model,HttpServletRequest request,HttpServletResponse response)  throws Exception{
		ReturnDatas returnObject = ReturnDatas.getSuccessReturnDatas();
		Map<String,DicData> map = dicDataService.findGongziConfigure();
		returnObject.setMap(map);
		return returnObject;
	}
	
	@RequestMapping("/configure/update")
	public @ResponseBody ReturnDatas configureUpdate(Model model,HttpServletRequest request,HttpServletResponse response)  throws Exception{
		ReturnDatas returnObject = ReturnDatas.getSuccessReturnDatas();
		String userNames = request.getParameter("userNames");
		String userPayDate = request.getParameter("userPayDate");
		Map<String,DicData> map = dicDataService.findGongziConfigure();
		DicData chakanData = map.get("chakanData");
		DicData bushengchengData = map.get("bushengchengData");
		if(chakanData == null){
			chakanData = new DicData();
			chakanData.setId(null);
			chakanData.setName(DicdataTypeEnum.员工工资查询时间.getName());
			chakanData.setTypekey(DicdataTypeEnum.员工工资查询时间.getValue());
		}
		if(bushengchengData == null){
			bushengchengData = new DicData();
			bushengchengData.setId(null);
			bushengchengData.setName(DicdataTypeEnum.不生成工资员工.getName());
			bushengchengData.setTypekey(DicdataTypeEnum.不生成工资员工.getValue());
		}
		chakanData.setCode(userPayDate);
		bushengchengData.setRemark(userNames);
		dicDataService.saveorupdate(chakanData);
		dicDataService.saveorupdate(bushengchengData);
		return returnObject;
	}
	
	@RequestMapping("/list/{oper}")
	public String list(@PathVariable String oper,Model model,HttpServletRequest request,HttpServletResponse response,Salary salary)  throws Exception{
//		String userId = request.getParameter("userId");
		ReturnDatas returnObject = listjson(oper, model, request, response, salary);
		model.addAttribute(GlobalStatic.returnDatas, returnObject);
		List<Org> orgList = orgService.findAllBumen();
		model.addAttribute("orgList", orgList);
		return "/erp/gz/userSalary/userSalaryList"+oper;
	}
	
	@RequestMapping("/list/{oper}/json")
	public @ResponseBody ReturnDatas listjson(@PathVariable String oper,Model model,HttpServletRequest request,HttpServletResponse response,Salary salary)  throws Exception{
		String inDateStr = request.getParameter("inDateStr");
		if(StringUtils.isBlank(inDateStr)){
			inDateStr = DateUtils.convertDate2String("yyyy-MM-01",new Date());
		}else{
			inDateStr = inDateStr+"-01";
		}
		salary.setInDate(DateUtils.convertString2Date(DateUtils.DATE_FORMAT, inDateStr));
		if(ErpStateEnum.operSalaryEnum.员工工资查询.getValue().equals(oper)){
			salary.setUserId(SessionUser.getUserId());
		}
		ReturnDatas returnObject = ReturnDatas.getSuccessReturnDatas();
		Page page = newPage(request);
		//获取工资基本项
		List<Salary> salaryList = salaryService.findUserBasicSalary(salary, page);
		List<UserSalaryDto> dtoList = new ArrayList<UserSalaryDto>();
		List<Set<String>> titleList = new ArrayList<Set<String>>();
		Set<String> salaryTitleSet = new HashSet<String>();
		Set<String> tongchouRecordTitleSet = new HashSet<String>();
		Set<String> tongchouZengjianTitleSet = new HashSet<String>();
		if(CollectionUtils.isNotEmpty(salaryList)){
			for(Salary s : salaryList){
				UserSalaryDto dto = getUserSalaryDtoBySalary(s);
				//获取工资增减项
				List<Salaryinfo> salaryinfoList = salaryinfoService.findListSalaryinfo(s.getUserId(), s.getInDate());
				if(CollectionUtils.isNotEmpty(salaryinfoList)){
					Map<String,BigDecimal> salaryinfoMap = new HashMap<String, BigDecimal>();
					for(Salaryinfo info : salaryinfoList){
						DicData data = dicDataService.findDicDataById(info.getSalaryTypeId());
						salaryinfoMap.put(data.getName(), info.getAmount());
						salaryTitleSet.add(data.getName());
					}
					
					dto.setSalaryinfoMap(salaryinfoMap);
				}
				//获取统筹记录
				List<TongchouRecord> tongchouRecordList = tongchouRecordService.finderRecordForList(s.getUserId(), s.getInDate());
				if(CollectionUtils.isNotEmpty(tongchouRecordList)){
					Map<String,BigDecimal> tongchouRecordMap = new HashMap<String, BigDecimal>();
					for(TongchouRecord record : tongchouRecordList){
						DicData data = dicDataService.findDicDataById(record.getInsuranceType());
						tongchouRecordMap.put(data.getName(), record.getInsurancePersonal());
						tongchouRecordTitleSet.add(data.getName());
					}
					
					dto.setTongchouRecordMap(tongchouRecordMap);
				}
				//获取统筹增减项
				List<TongchouZengjian> tongchouZengjianList = tongchouZengjianService.finderTczjxForFenzuList(s.getUserId(), s.getInDate());
				if(CollectionUtils.isNotEmpty(tongchouZengjianList)){
					Map<String,BigDecimal> tongchouZengjianMap = new HashMap<String, BigDecimal>();
					for(TongchouZengjian tczj : tongchouZengjianList){
						DicData insurance = dicDataService.findDicDataById(tczj.getInsuranceType());
						DicData feiyong = dicDataService.findDicDataById(tczj.getFeiyongtype());
						tongchouZengjianMap.put(insurance.getName()+"-"+feiyong.getName(), tczj.getInsurancePersonal());
						tongchouZengjianTitleSet.add(insurance.getName()+"-"+feiyong.getName());
					}
					
					dto.setTongchouZengjianMap(tongchouZengjianMap);
				}
				dtoList.add(dto);
			}
		}
		titleList.add(tongchouRecordTitleSet);
		titleList.add(salaryTitleSet);
		titleList.add(tongchouZengjianTitleSet);
		returnObject.setData(dtoList);
		returnObject.setPage(page);
		returnObject.setQueryBean(salary);
		model.addAttribute("titleList", titleList);
		return returnObject;
	}
	
	private UserSalaryDto getUserSalaryDtoBySalary(Salary salary) throws Exception{
		UserSalaryDto dto = new UserSalaryDto();
		dto.setSalaryId(salary.getId());
		dto.setUserName(salary.getUserName());
		dto.setInDate(salary.getInDate());
		dto.setJibenpay(salary.getJibenpay());
		dto.setKaohepay(salary.getKaohepay());
		dto.setGangweipay(salary.getGangweipay());
		dto.setTongchoupay(salary.getTongchoupay());
		dto.setGongziPlusPay(salary.getGongziPlusPay());
		dto.setRipay(salary.getRipay());
		dto.setGeshui(salary.getGeshui());
		dto.setYingfupay(salary.getYingfupay());
		dto.setShifupay(salary.getShifupay());
		if(StringUtils.isNotBlank(salary.getCompanyId())){
			DicData company = dicDataService.findDicDataById(salary.getCompanyId());
			if(company != null){
				dto.setCompanyName(company.getName());
			}
		}
		if(StringUtils.isNotBlank(salary.getUnitId())){
			List<Org> orgList = orgService.findOrgByOrgIds(salary.getUnitId());
			if(CollectionUtils.isNotEmpty(orgList)){
				StringBuilder sb = new StringBuilder();
				int f = 0 ;
				for(Org o : orgList){
					if(f == 0){
						sb.append(o.getName());
					}else{
						sb.append(",").append(o.getName());
					}
					f++;
				}
				dto.setUnitName(sb.toString());
			}
		}
		if(salary.getState() != null){
			dto.setPayStateStr(SalaryStateEnum.getName(salary.getState()));
		}
		return dto;
	}
}
